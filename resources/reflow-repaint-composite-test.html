<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reflow · Repaint · Composite · will-change — DevTools 실습</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, Apple SD Gothic Neo, "Noto Sans KR", sans-serif; }
    body { margin: 24px; line-height: 1.6; }
    h1 { margin-bottom: 0.25rem; }
    h2 { margin-top: 2rem; }
    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 12px; }
    .note { font-size: 0.95rem; color: #333; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #bbb; background: #fafafa; cursor: pointer; }
    button:active { transform: translateY(1px); }
    code { background: #f6f8fa; padding: 2px 6px; border-radius: 6px; }
    .box { width: 120px; height: 60px; border-radius: 8px; display: grid; place-items: center; color: #fff; font-weight: 600; }
    .box--a { background: #5865f2; }
    .box--b { background: #0ea5e9; }
    .box--c { background: #22c55e; }
    .w-120 { width: 120px; } .w-480 { width: 480px; }
    .bg1 { background: #f59e0b; } .bg2 { background: #ef4444; }
    /* composite-demo elements */
    .layer-demo { width: 120px; height: 60px; background: #22c55e; color: #fff; display: grid; place-items: center; border-radius: 10px; }
    .promote { will-change: transform, opacity; } /* toggle this to pre-promote to a compositing layer */
    .playground { position: relative; overflow: hidden; height: 120px; border: 1px dashed #ccc; border-radius: 8px; }
    .moving { position: absolute; top: 30px; left: 0; }
    /* stress list */
    .list { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; }
    .cell { height: 18px; background: #eee; }
    .cell.paint { background: #60a5fa; }         /* paint-only change */
    .cell.layout { margin-top: 4px; }            /* triggers layout */
  </style>
</head>
<body>
  <h1>Reflow · Repaint · Composite · will-change — DevTools 실습</h1>
  <p class="note">각 섹션의 버튼을 클릭하면서 DevTools의 <b>Performance</b> / <b>Layers</b> / <b>Rendering</b> 패널로 Layout/Paint/Composite 이벤트와 레이어 승격을 확인해보세요.</p>

  <!-- 1) Reflow (Layout) test -->
  <h2>① Reflow 테스트 (Layout 발생)</h2>
  <div class="card">
    <div class="row">
      <button id="toggleWidth">width 토글 (120px ↔ 480px)</button>
      <span class="note">→ <code>width</code> 변경은 레이아웃을 다시 계산(Reflow)하게 됩니다.</span>
    </div>
    <div class="row" style="margin-top: 12px;">
      <div id="layoutBox" class="box box--a w-120">Layout Box</div>
      <div class="note">Performance 탭에서 <b>Layout</b> 이벤트를 확인하세요.</div>
    </div>
  </div>

  <!-- 2) Repaint test -->
  <h2>② Repaint 테스트 (Paint만 발생)</h2>
  <div class="card">
    <div class="row">
      <button id="toggleColor">background-color 토글</button>
      <span class="note">→ <code>background-color</code> 변경은 Paint만 일으킵니다.</span>
    </div>
    <div class="row" style="margin-top: 12px;">
      <div id="paintBox" class="box box--b bg1">Paint Box</div>
      <div class="note">Performance 탭에서 <b>Paint</b> 이벤트를 확인하세요.</div>
    </div>
  </div>

  <!-- 3) Composite test (transform/opacity) + will-change toggle -->
  <h2>③ Composite 테스트 (transform/opacity) + <code>will-change</code></h2>
  <div class="card">
    <div class="row" style="gap:24px;">
      <div class="row">
        <button id="startTransform">transform 애니메이션 시작</button>
        <button id="stopTransform">정지</button>
      </div>
      <label class="row" style="gap:8px;">
        <input type="checkbox" id="toggleWillChange" />
        <span><code>will-change: transform, opacity</code> 미리 적용(레이어 승격 사전 예약)</span>
      </label>
      <label class="row" style="gap:8px;">
        <input type="checkbox" id="toggleOpacityAnim" />
        <span>opacity도 함께 애니메이션</span>
      </label>
    </div>

    <div class="playground" style="margin-top: 12px;">
      <div id="moving" class="layer-demo moving">Composite</div>
    </div>

    <ul class="note" style="margin-top: 8px;">
      <li>Layers 패널 또는 Rendering → <b>Layer borders</b>로 합성 레이어 승격 여부 확인</li>
      <li>Rendering → <b>Paint flashing</b> 활성화해 <code>transform</code> 애니메이션에서 페인트가 발생하지 않는지 확인</li>
      <li>Performance 타임라인에서 <b>Layout / Paint / Composite</b> 이벤트 비교</li>
    </ul>
  </div>

  <!-- 4) Stress: 대량 노드에서 layout vs paint 비교 -->
  <h2>④ Stress 테스트 (대량 노드: layout vs paint 비교)</h2>
  <div class="card">
    <div class="row">
      <button id="makePaintChange">1000개 셀에 paint-only 클래스 토글</button>
      <button id="makeLayoutChange">1000개 셀에 layout 클래스 토글</button>
      <button id="resetCells">리셋</button>
    </div>
    <div id="grid" class="list" style="margin-top: 12px;"></div>
    <p class="note">같은 개수의 노드에 대해 <b>paint-only</b>와 <b>layout</b> 변경을 각각 적용하고 Performance에서 비용 차이를 비교해 보세요.</p>
  </div>

  <script>
    // ① Layout test
    const layoutBox = document.getElementById('layoutBox');
    document.getElementById('toggleWidth').addEventListener('click', () => {
      layoutBox.classList.toggle('w-480');
      layoutBox.classList.toggle('w-120');
    });

    // ② Paint test
    const paintBox = document.getElementById('paintBox');
    document.getElementById('toggleColor').addEventListener('click', () => {
      paintBox.classList.toggle('bg1');
      paintBox.classList.toggle('bg2');
    });

    // ③ Composite + will-change
    const moving = document.getElementById('moving');
    const chkWillChange = document.getElementById('toggleWillChange');
    const chkOpacity = document.getElementById('toggleOpacityAnim');
    let rafId = null;
    let t = 0;
    const width = 600; // travel distance in px within playground

    function animate() {
      t += 0.016; // ~60fps
      // ping-pong easing
      const progress = 0.5 + 0.5 * Math.sin(t);
      const x = progress * (width - 120); // box width=120
      moving.style.transform = `translate3d(${x}px, 0, 0)`; // compositor-only
      if (chkOpacity.checked) {
        const op = 0.5 + 0.5 * Math.cos(t);
        moving.style.opacity = op.toFixed(3); // compositor-only
      }
      rafId = requestAnimationFrame(animate);
    }

    document.getElementById('startTransform').addEventListener('click', () => {
      if (chkWillChange.checked) {
        moving.classList.add('promote'); // pre-promote to its own compositing layer
      }
      if (!rafId) {
        animate();
      }
    });

    document.getElementById('stopTransform').addEventListener('click', () => {
      cancelAnimationFrame(rafId);
      rafId = null;
      moving.style.transform = 'translate3d(0,0,0)';
      moving.style.opacity = '1';
      moving.classList.remove('promote');
    });

    chkWillChange.addEventListener('change', (e) => {
      if (e.target.checked) {
        moving.classList.add('promote');
      } else {
        moving.classList.remove('promote');
      }
    });

    // ④ Stress list
    const grid = document.getElementById('grid');
    const FRAG = document.createDocumentFragment();
    for (let i = 0; i < 1000; i++) {
      const div = document.createElement('div');
      div.className = 'cell';
      FRAG.appendChild(div);
    }
    grid.appendChild(FRAG);

    document.getElementById('makePaintChange').addEventListener('click', () => {
      grid.querySelectorAll('.cell').forEach(el => el.classList.toggle('paint'));
    });

    document.getElementById('makeLayoutChange').addEventListener('click', () => {
      grid.querySelectorAll('.cell').forEach(el => el.classList.toggle('layout'));
    });

    document.getElementById('resetCells').addEventListener('click', () => {
      grid.querySelectorAll('.cell').forEach(el => el.classList.remove('paint', 'layout'));
    });
  </script>
</body>
</html>
